name: RELEASE [PRODUCTION] - Create Release PR

on:
  pull_request_target:
    types: [closed]
    branches:
      - pre-production

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  create_release_pr:
    name: Create Release Pull Request
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged == true }}

    steps:
      - name: Checkout pre-production Branch
        uses: actions/checkout@v4
        with:
          ref: pre-production
          fetch-depth: 0

      - name: Verify Changes Exist
        run: |
          git fetch origin main pre-production

          COMMITS=$(git rev-list --count origin/main..origin/pre-production)

          if [ "$COMMITS" -eq 0 ]; then
            echo "‚ùå No hay commits nuevos en pre-production respecto a main"
            exit 1
          fi

          echo "‚úÖ Hay $COMMITS commits nuevos en pre-production"
          git log origin/main..origin/pre-production --oneline

      - name: Create Release PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRE_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          RELEASE_TITLE=$(echo "$PRE_TITLE" | sed 's/PRE-RELEASE/RELEASE/')

          gh pr create \
            --title "$RELEASE_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head pre-production \
            --label "release" \
            --assignee "${{ github.actor }}"

      - name: Notify Completion
        run: |
          echo "‚úÖ Release PR created successfully!"
          echo "üîó Check the PR in GitHub to review all changes."
          echo "üöÄ Next step: Merge the Release PR to main to trigger the tagging workflow."
